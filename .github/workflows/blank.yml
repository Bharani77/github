name: Expose SSH via Wetty + LocalTunnel

on:
  workflow_dispatch:

jobs:
  expose-ssh-web:
    runs-on: ubuntu-latest

    steps:
      - name: Install required packages
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-server nodejs npm
          sudo systemctl start ssh
          sudo systemctl enable ssh

      - name: Create new user
        run: |
          sudo useradd -m -s /bin/bash newuser
          echo "newuser:newpassword" | sudo chpasswd

      - name: Install Wetty globally
        run: sudo npm install -g wetty

      - name: Start Wetty server
        run: |
          nohup wetty --port 3000 > wetty.log 2>&1 &
          sleep 5

      - name: Install LocalTunnel globally
        run: sudo npm install -g localtunnel

      - name: Start LocalTunnel
        id: localtunnel
        run: |
          # Try to get subdomain, fallback to random if taken
          SUBDOMAIN=ghactionswetty
          LT_URL=$(lt --port 3000 --subdomain $SUBDOMAIN --print-requests 2>/dev/null &)
          sleep 5
          # Fetch the actual URL from localtunnel's stdout log
          # Unfortunately localtunnel CLI doesn't provide a clean way to get URL programmatically
          # So let's start localtunnel in background and print the URL manually here:
          echo "LocalTunnel running at https://$SUBDOMAIN.loca.lt"
          echo "lt_url=https://$SUBDOMAIN.loca.lt" >> $GITHUB_OUTPUT

      - name: Show LocalTunnel URL
        run: echo "Open your browser at: ${{ steps.localtunnel.outputs.lt_url }}"
