name: Expose SSH via Web Terminal + LocalTunnel
on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Duration to keep tunnel alive (minutes)'
        required: true
        default: '60'
        type: string
      password:
        description: 'Password for SSH user'
        required: true
        type: string

jobs:
  expose-ssh-web:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: Install required packages
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-server nodejs npm
          sudo systemctl start ssh
          sudo systemctl enable ssh

      - name: Create SSH user
        run: |
          sudo useradd -m -s /bin/bash sshuser
          echo "sshuser:${{ github.event.inputs.password }}" | sudo chpasswd
          sudo usermod -aG sudo sshuser
          echo "âœ… Created user 'sshuser' with sudo privileges"

      - name: Install and configure ttyd (Web Terminal)
        run: |
          # Download ttyd (more reliable than wetty for this use case)
          wget -q https://github.com/tsl0922/ttyd/releases/download/1.7.3/ttyd.x86_64
          chmod +x ttyd.x86_64
          sudo mv ttyd.x86_64 /usr/local/bin/ttyd
          echo "âœ… ttyd installed successfully"

      - name: Install LocalTunnel
        run: |
          sudo npm install -g localtunnel
          echo "âœ… LocalTunnel installed"

      - name: Start Web Terminal
        run: |
          # Start ttyd with login shell
          nohup ttyd -p 3000 -i 0.0.0.0 -t titleFixed=GitHub-Actions-SSH -t fontSize=16 login > ttyd.log 2>&1 &
          sleep 5
          
          # Check if ttyd is running
          if pgrep -f ttyd > /dev/null; then
            echo "âœ… ttyd server started on port 3000"
            # Test local connection
            if curl -s http://localhost:3000 | grep -q "ttyd"; then
              echo "âœ… ttyd responding correctly"
            else
              echo "âš ï¸ ttyd may not be responding properly"
              echo "ttyd log:"
              cat ttyd.log
            fi
          else
            echo "âŒ Failed to start ttyd"
            cat ttyd.log
            exit 1
          fi

      - name: Start LocalTunnel
        run: |
          # Start LocalTunnel
          nohup lt --port 3000 > lt.log 2>&1 &
          sleep 10
          
          # Extract URL with multiple attempts
          for i in {1..5}; do
            TUNNEL_URL=$(grep -o 'https://.*\.loca\.lt' lt.log | head -1)
            if [ -n "$TUNNEL_URL" ]; then
              break
            fi
            echo "Attempt $i: Waiting for LocalTunnel URL..."
            sleep 5
          done
          
          if [ -n "$TUNNEL_URL" ]; then
            echo "ðŸŽ‰ SUCCESS! Web Terminal is ready!"
            echo "=================================="
            echo "ðŸŒ URL: $TUNNEL_URL"
            echo "ðŸ‘¤ Username: sshuser"
            echo "ðŸ”‘ Password: [your provided password]"
            echo "â° Duration: ${{ github.event.inputs.duration }} minutes"
            echo "=================================="
            echo ""
            echo "ðŸ“‹ To bypass LocalTunnel reminder:"
            echo "   â€¢ Add header: bypass-tunnel-reminder: true"
            echo "   â€¢ Or use custom User-Agent"
            echo "   â€¢ Browser extension: ModHeader (recommended)"
            echo ""
            echo "ðŸ”§ Test command:"
            echo "curl -H 'bypass-tunnel-reminder: true' $TUNNEL_URL"
            
            # Write to GitHub step summary
            echo "## ðŸš€ Web SSH Terminal Ready" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| **URL** | $TUNNEL_URL |" >> $GITHUB_STEP_SUMMARY
            echo "| **Username** | sshuser |" >> $GITHUB_STEP_SUMMARY
            echo "| **Duration** | ${{ github.event.inputs.duration }} minutes |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”§ Bypass Reminder Instructions:" >> $GITHUB_STEP_SUMMARY
            echo "- Install **ModHeader** browser extension" >> $GITHUB_STEP_SUMMARY
            echo "- Add header: \`bypass-tunnel-reminder: true\`" >> $GITHUB_STEP_SUMMARY
            echo "- Or set custom User-Agent: \`MyBrowser/1.0\`" >> $GITHUB_STEP_SUMMARY
            
            # Test the tunnel
            echo ""
            echo "ðŸ§ª Testing tunnel connectivity..."
            if curl -s -H "bypass-tunnel-reminder: true" "$TUNNEL_URL" | grep -q "ttyd"; then
              echo "âœ… Tunnel is working correctly!"
            else
              echo "âš ï¸ Tunnel test inconclusive - but should work in browser"
            fi
            
          else
            echo "âŒ Failed to get LocalTunnel URL"
            echo "LocalTunnel log:"
            cat lt.log
            exit 1
          fi

      - name: Keep session alive
        run: |
          echo "ðŸ• Keeping session alive for ${{ github.event.inputs.duration }} minutes..."
          echo "Press Ctrl+C in the Actions tab to stop early"
          
          # Keep alive with periodic status updates
          DURATION_SECONDS=$((${{ github.event.inputs.duration }} * 60))
          INTERVAL=300  # 5 minutes
          ELAPSED=0
          
          while [ $ELAPSED -lt $DURATION_SECONDS ]; do
            if [ $((ELAPSED % INTERVAL)) -eq 0 ] && [ $ELAPSED -gt 0 ]; then
              REMAINING=$(((DURATION_SECONDS - ELAPSED) / 60))
              echo "â° Still alive - $REMAINING minutes remaining"
            fi
            sleep 60
            ELAPSED=$((ELAPSED + 60))
          done
          
          echo "â° Session time expired. Shutting down..."

      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up..."
          pkill -f ttyd || true
          pkill -f localtunnel || true
          sudo userdel -r sshuser 2>/dev/null || true
          echo "âœ… Cleanup completed"
