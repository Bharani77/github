name: Chrome Browser Web Interface
on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Duration to keep tunnel alive (minutes)'
        required: true
        default: '60'
        type: string
      password:
        description: 'VNC Password'
        required: true
        type: string

jobs:
  chrome-web:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y wget curl nodejs npm
          
          # Install Chrome
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          
          # Install VNC and GUI components
          sudo apt-get install -y tigervnc-standalone-server fluxbox xterm
          
          echo "âœ… Environment setup complete"

      - name: Configure VNC
        run: |
          # Create VNC directory and set password
          mkdir -p ~/.vnc
          echo "${{ github.event.inputs.password }}" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
          # Create VNC startup script
          cat > ~/.vnc/xstartup << 'XSTART'
#!/bin/bash
fluxbox &
sleep 3
google-chrome --no-sandbox --disable-dev-shm-usage --disable-gpu --start-maximized --no-first-run "https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo" &
XSTART
          
          chmod +x ~/.vnc/xstartup
          echo "âœ… VNC configured"

      - name: Start VNC server
        run: |
          vncserver :1 -geometry 1920x1080 -depth 24
          sleep 10
          echo "âœ… VNC server started"

      - name: Setup web interface
        run: |
          # Install websockify for VNC web access
          pip3 install websockify
          
          # Download noVNC
          wget https://github.com/novnc/noVNC/archive/refs/tags/v1.4.0.tar.gz
          tar xf v1.4.0.tar.gz
          mv noVNC-1.4.0 novnc
          
          echo "âœ… Web interface ready"

      - name: Start web server
        run: |
          cd novnc
          # Start websockify to bridge VNC to web
          websockify --web . 6080 localhost:5901 &
          sleep 5
          echo "âœ… Web server running on port 6080"

      - name: Create tunnel
        run: |
          npm install -g localtunnel
          
          # Start tunnel
          nohup lt --port 6080 > tunnel.log 2>&1 &
          sleep 15
          
          # Get tunnel URL
          TUNNEL_URL=$(grep -o 'https://.*\.loca\.lt' tunnel.log | head -1)
          
          if [ -n "$TUNNEL_URL" ]; then
            echo "ğŸ‰ SUCCESS! Chrome Browser is Ready!"
            echo "================================================"
            echo "ğŸŒ URL: $TUNNEL_URL"
            echo "ğŸ”‘ Password: ${{ github.event.inputs.password }}"
            echo "â° Duration: ${{ github.event.inputs.duration }} minutes"
            echo "================================================"
            echo ""
            echo "ğŸ“‹ How to Use:"
            echo "1. Click the URL above"
            echo "2. Click 'Connect' button"
            echo "3. Enter your password"
            echo "4. Chrome will appear with Tampermonkey page"
            echo "5. Click 'Add to Chrome' to install Tampermonkey"
            echo ""
            echo "âœ¨ You'll see the actual Chrome browser interface!"
            
            # GitHub summary
            echo "## ğŸš€ Chrome Browser Ready" >> $GITHUB_STEP_SUMMARY
            echo "**URL:** $TUNNEL_URL" >> $GITHUB_STEP_SUMMARY
            echo "**Password:** ${{ github.event.inputs.password }}" >> $GITHUB_STEP_SUMMARY
            echo "**Usage:** Click URL â†’ Connect â†’ Enter Password â†’ Use Chrome" >> $GITHUB_STEP_SUMMARY
            
          else
            echo "âŒ Failed to create tunnel"
            cat tunnel.log
            exit 1
          fi

      - name: Keep alive
        run: |
          echo "ğŸ• Keeping session alive for ${{ github.event.inputs.duration }} minutes..."
          sleep $((${{ github.event.inputs.duration }} * 60))
          echo "â° Session ended"

      - name: Cleanup
        if: always()
        run: |
          pkill -f localtunnel || true
          pkill -f websockify || true
          vncserver -kill :1 || true
          echo "âœ… Cleanup complete"
